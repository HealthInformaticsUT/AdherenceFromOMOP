---
title: "Getting Started"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Getting started with the basics

## Calculating adherence

Using adherenceFromOMOP involves two main steps. First, the required data must be retrieved and written to a designated table in the database.

```{r, eval = FALSE, echo = FALSE, message = FALSE}
# Step 0 - cdm connection
devtools::load_all()
cdm <- mockAdherenceFromOMOP()
cdm
```

To extract the necessary data, use generateChronicDrugExposure. For drugConceptIdList input variable, which expects drug_concept_id values in a list, it is recommended to use [CodelistGenerator](https://darwin-eu.github.io/CodelistGenerator/reference/getDrugIngredientCodes.html).

```{r, eval = FALSE, echo=FALSE, message = FALSE}
# recommended method for acquiring drug_concept_id values
drugIngredientCodes <- CodelistGenerator::getDrugIngredientCodes(cdm = cdm, name = c(42899580, 37498042))
concepts_ids <- unlist(drugIngredientCodes, use.names = F)

# Step 1 - data generation
chronicDrugExposure <- generateChronicDrugExposure(
  cdm = cdm,
  # drugConceptIdList = concepts_ids,
  name = "chronic_drug_exposure_table",
  overwrite = T
)

chronicDrugExposure
```


Medication groups can be defined to calculate adherence by therapeutic category.
Here, we reuse the earlier drugIngredientCodes object. To compute adherence, for large datasets use the loader functions.

```{r, eval = FALSE, message = FALSE}
adherenceCalculationsLoader(
  reference = chronicDrugExposure,
  cdm = cdm,
  medicationGroup = drugIngredientCodes,
  resultsTableName = "name_of_table_that_contains_cma",
  cma = c(
    "CMA3"
  )
)
```

## Adding features to CMA values

You can add features either to the sliding-window periods or to the overall observation period.

### Adding BMI values

```{r, eval = FALSE}
data <- addBMI(CMA_sliding_window_for_each_patient, cdm)
```

### Adding cohort membership as columns 

```{r,eval = FALSE}
# when using notebook this command has to be copied to the console
pathToCohorts <- "./inst/"

cohortSet <- CDMConnector::readCohortSet(pathToCohorts)
cdm <- CDMConnector::generateCohortSet(cdm, cohortSet, name = "cohort")

cohort <- dplyr::collect(cdm$cohort)

addCohorts(CMA_sliding_window_for_each_patient, cohort)
```
